#!/bin/bash
SHELLPACK_ROOT=$(dirname $(realpath -s ${BASH_SOURCE[0]}))
SHELLPACK_BIN=$SHELLPACK_ROOT/../../bin/

LOGDIR=${1:-`pwd`}
cd $LOGDIR || exit 1

# Required output format, tab delimited
# - metric factorA factorB interval value extra
# Where;
# metric:	A primary metric like time, a specific operation e.g. Latency, Elapsed, transaction
# factorA:	Statistically relevant modifier such as percentile, thread count, worker etc
# factorB:	Secondary factor
# interval:	e.g. time elapsed, iteration etc
# value:	the benchmark measurement
# extra:	Optional value, currently used to identify a metric+factor for dashboard comparisons
for HEADING in `ls benchlog-*-1.xz | awk -F - '{print $2}'`; do
	for NR_CLIENT in `\ls benchlog-$HEADING-*.xz | sed -e 's/.xz$//' | cut -f3 -d- | sort -n`; do
		case $HEADING in
		loadfile)
			xzcat benchlog-$HEADING-$NR_CLIENT.xz |
				awk '{ print \
					"loadfile",	# metric
					nr,		# factorA
					"_",		# factorB
					$8/1000,	# interval
					$4,		# value
					"R"		# extra
				    }' OFS="\t" nr=$NR_CLIENT
			;;
		tput)
			xzcat benchlog-$HEADING-$NR_CLIENT.xz |
				awk '{ print \
					"tput",		# metric
					nr,		# factorA
					"_",		# factorB
					$6,		# interval
					$3,		# value
					"_"		# extra
				    }' OFS="\t" nr=$NR_CLIENT
			;;
		op)
			xzcat benchlog-$HEADING-$NR_CLIENT.xz |
				awk '{ print \
					"op-"$1,	# metric
					nr,		# factorA
					"_",		# factorB
					0,		# interval
					$3,		# value
					"_"		# extra
				}' OFS="\t" nr=$NR_CLIENT
			;;
		*)
		esac
	done
done | sort -k1,1 -k2,2n -k4,4n
